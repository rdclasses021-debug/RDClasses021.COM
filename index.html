<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RD CLASSES | Premium Portal</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /* --- 1. MODERN VARIABLES & RESET --- */
        :root {
            --primary: #4F46E5; /* Indigo */
            --primary-dark: #4338ca;
            --accent: #06b6d4; /* Cyan */
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #0f172a;
            --text-muted: #64748B;
            --bg-body: #F3F4F6;
            --surface: #FFFFFF;
            
            --font-main: 'Plus Jakarta Sans', sans-serif;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --radius-xl: 1.5rem;
            --radius-lg: 1rem;
            --radius-md: 0.75rem;
        }

        body {
            background-color: var(--bg-body);
            font-family: var(--font-main);
            color: var(--dark);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* --- 2. GLOBAL COMPONENTS --- */
        .btn {
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
        }

        .btn-brand {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-brand:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
            color: white;
        }

        .card-modern {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .card-modern:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .form-control, .form-select {
            border-radius: var(--radius-md);
            padding: 0.8rem 1rem;
            border: 1px solid #E2E8F0;
            background-color: #F8FAFC;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-control:focus, .form-select:focus {
            background-color: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        /* --- 3. LOGIN PAGE --- */
        #auth-view {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(120deg, #4f46e5 0%, #06b6d4 100%);
            position: relative;
            padding: 20px;
        }
        
        #auth-view::before {
            content: ''; position: absolute; width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 10;
        }

        /* --- 4. LAYOUT & NAVIGATION (Responsive) --- */
        .sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0; top: 0;
            background: var(--surface);
            border-right: 1px solid #E2E8F0;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 3rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: var(--text-muted);
            border-radius: var(--radius-md);
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link i { width: 24px; font-size: 1.1rem; }

        .nav-link:hover {
            background: #F1F5F9;
            color: var(--primary);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
        }

        .main-content {
            margin-left: 280px;
            padding: 2.5rem;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* --- 5. RESPONSIVE TABLE --- */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid #E2E8F0;
            overflow-x: auto;
            position: relative;
        }

        .table { 
            margin-bottom: 0; 
            border-collapse: separate; 
            border-spacing: 0; 
            width: 100%;
            white-space: nowrap; 
        }
        
        .table thead th {
            background: #F8FAFC;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            padding: 1.2rem 1rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 1rem;
            border-bottom: 1px solid #F1F5F9;
            font-size: 0.9rem;
            color: var(--dark);
        }

        .table tbody tr:hover { background-color: #F8FAFC; }

        .sticky-col {
            position: sticky; 
            left: 0; 
            background: white; 
            z-index: 5;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            min-width: 180px;
            max-width: 200px;
        }
        .table tbody tr:hover .sticky-col { background-color: #F8FAFC; }

        input[type="checkbox"] {
            width: 20px; height: 20px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        /* --- 6. STUDENT VIEW & NOTIFICATION POPUP --- */
        #student-view { display: none; }
        
        /* ALERTS */
        #student-alert-box, #fee-alert-box {
            position: fixed;
            bottom: -200px; 
            left: 0; right: 0;
            color: white;
            padding: 15px;
            text-align: center;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 9999;
            transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        #student-alert-box { background: #3B82F6; box-shadow: 0 -10px 30px rgba(59, 130, 246, 0.4); }
        #fee-alert-box { background: #EF4444; box-shadow: 0 -10px 30px rgba(239, 68, 68, 0.5); font-weight: bold; }
        #student-alert-box.active, #fee-alert-box.active { bottom: 0; }

        .student-hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            padding: 60px 0 100px;
            border-bottom-left-radius: 60px;
            border-bottom-right-radius: 60px;
            color: white;
            text-align: center;
            margin-bottom: -70px;
            position: relative;
            overflow: hidden;
        }
        
        .id-card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .month-grid-item {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: var(--radius-md);
            transition: 0.2s;
        }
        .month-grid-item:hover { transform: translateY(-3px); border-color: var(--primary); }

        /* --- 7. UTILITIES --- */
        .page-section { display: none; animation: fadeIn 0.4s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .avatar-circle {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: #E2E8F0;
            object-fit: cover;
        }

        /* Stat Cards */
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border: 1px solid #E2E8F0;
        }
        .stat-icon-bg {
            position: absolute; right: -10px; bottom: -10px;
            font-size: 5rem; opacity: 0.05; transform: rotate(-10deg);
        }

        /* --- 8. MOBILE NAV: ROUNDED & FLOATING --- */
        @media (max-width: 991px) {
            .sidebar {
                width: 90%; 
                height: 70px;
                position: fixed;
                bottom: 20px; 
                left: 50%;
                top: auto;
                transform: translateX(-50%); 
                padding: 0;
                border: 1px solid rgba(255,255,255,0.5);
                border-radius: 25px; 
                background: rgba(255, 255, 255, 0.95); 
                backdrop-filter: blur(12px);
                z-index: 1050;
                flex-direction: row; 
                justify-content: center;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            }

            .sidebar nav { 
                display: flex; 
                flex-direction: row; 
                width: 100%; 
                height: 100%; 
                justify-content: space-evenly; 
                align-items: center; 
            }

            .sidebar-logo { display: none; }
            .sidebar .mt-auto { display: none; }

            .nav-link {
                flex-direction: column; 
                justify-content: center; 
                align-items: center;
                padding: 0; margin: 0; 
                width: auto; height: 100%;
                background: transparent !important; 
                color: #94A3B8;
                border-radius: 0; 
                font-size: 0.65rem; 
                font-weight: 600; 
                gap: 2px;
                transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            .nav-link i { 
                font-size: 1.4rem; 
                margin-bottom: 0; 
                transition: transform 0.3s ease;
            }

            .nav-link.active { 
                color: var(--primary) !important; 
                box-shadow: none; 
            }
            
            .nav-link.active i {
                transform: scale(1.3) translateY(-3px); 
                filter: drop-shadow(0 4px 6px rgba(79, 70, 229, 0.3));
            }
            
            .main-content { margin-left: 0; padding: 1.5rem 1rem; padding-bottom: 110px; }
            #page-overview .d-flex.flex-md-row { flex-direction: column !important; align-items: flex-start !important; }
            .card-modern.d-flex { flex-direction: column; gap: 1rem; }
            .card-modern .flex-grow-1, .card-modern .border-start { width: 100% !important; border-left: none !important; border-top: 1px solid #F1F5F9; padding-top: 10px; padding-left: 0 !important; }
            .col-md-4 { width: 100%; } 
            #mobile-logout-btn { display: block !important; }
        }

        #mobile-logout-btn { display: none; position: fixed; top: 15px; right: 15px; z-index: 1002; }

        /* TOAST */
        #custom-toast {
            visibility: hidden;
            min-width: 300px;
            background: #1e293b; 
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px 24px;
            position: fixed;
            z-index: 10000;
            left: 50%;
            bottom: -100px;
            transform: translateX(-50%);
            transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #custom-toast.show { visibility: visible; bottom: 100px; }
        #custom-toast i { font-size: 1.2rem; }
        
        /* Capture Areas */
        #receipt-capture-area, #year-report-capture-area { position: absolute; top: -9999px; left: -9999px; width: 800px; background: white; padding: 40px; }
        @media print { .sidebar, .no-print, #auth-view { display: none !important; } .main-content { margin: 0; padding: 0; } #student-view { display: block; } }
    </style>
</head>
<body>

    <!-- 1. AUTH LOGIN VIEW -->
    <div id="auth-view">
        <div class="login-card text-center">
            <div class="mb-4 d-inline-block p-3 rounded-circle bg-white text-primary shadow-sm">
                <i class="fas fa-graduation-cap fa-3x"></i>
            </div>
            <h2 class="fw-bold text-dark inst-name-display mb-1">RD CLASSES</h2>
            <p class="text-muted small mb-4">Secure Administration Portal</p>
            
            <form onsubmit="event.preventDefault(); window.handleLogin();">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="loginUser" placeholder="Username">
                    <label>Username</label>
                </div>
                <div class="form-floating mb-4">
                    <input type="password" class="form-control" id="loginPass" placeholder="Password">
                    <label>Password</label>
                </div>
                <button type="submit" class="btn btn-brand w-100 py-3 shadow-hover">
                    Access Dashboard <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- 2. ADMIN DASHBOARD -->
    <div id="dashboard-view" style="display: none;">
        
        <!-- Mobile Logout -->
        <button id="mobile-logout-btn" class="btn btn-white rounded-circle shadow-md no-print" onclick="window.logout()">
            <i class="fas fa-power-off text-danger"></i>
        </button>

        <!-- Sidebar / Bottom Nav -->
        <div class="sidebar">
            <div class="sidebar-logo inst-name-display">
                <i class="fas fa-shapes"></i> RD CLASSES
            </div>
            <nav class="flex-grow-1">
                <div onclick="window.switchPage('overview')" class="nav-link active" id="nav-overview">
                    <i class="fas fa-th-large"></i> <span>Overview</span>
                </div>
                <div onclick="window.switchPage('analytics')" class="nav-link" id="nav-analytics">
                    <i class="fas fa-chart-pie"></i> <span>Analytics</span>
                </div>
                <div onclick="window.switchPage('settings')" class="nav-link" id="nav-settings">
                    <i class="fas fa-cog"></i> <span>Settings</span>
                </div>
                <div onclick="window.switchPage('profile')" class="nav-link" id="nav-profile">
                    <i class="fas fa-user-circle"></i> <span>Profile</span>
                </div>
            </nav>
            <div class="mt-auto pt-4 border-top">
                <button onclick="window.logout()" class="btn btn-light w-100 text-danger fw-bold">
                    <i class="fas fa-sign-out-alt me-2"></i> Sign Out
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            
            <!-- OVERVIEW PAGE -->
            <div id="page-overview" class="page-section active">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
                    <div>
                        <h2 class="fw-bold mb-0">Fee Management</h2>
                    </div>
                    <div class="d-flex gap-2 w-100 w-md-auto justify-content-end">
                        <div class="dropdown">
                            <button class="btn btn-white bg-white border shadow-sm dropdown-toggle px-3" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-download me-2 text-muted"></i> Export
                            </button>
                            <ul class="dropdown-menu border-0 shadow-lg rounded-4 p-2">
                                <li><a class="dropdown-item rounded-3 mb-1" href="#" onclick="window.exportToExcel()"><i class="fas fa-file-excel text-success me-2"></i> Excel Sheet</a></li>
                                <li><a class="dropdown-item rounded-3 mb-1" href="#" onclick="window.exportToWord()"><i class="fas fa-file-word text-primary me-2"></i> Word Doc</a></li>
                                <li><a class="dropdown-item rounded-3" href="#" onclick="window.exportToImage()"><i class="fas fa-image text-danger me-2"></i> Image File</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-brand px-3" onclick="window.openAddModal()">
                            <i class="fas fa-plus me-1"></i> Add
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card-modern p-3 mb-4 d-flex flex-wrap gap-3 align-items-center">
                    <div class="flex-grow-1 position-relative w-100 w-md-auto">
                        <i class="fas fa-search position-absolute text-muted" style="left: 20px; top: 14px;"></i>
                        <input type="text" id="searchBox" class="form-control border-0 ps-5" placeholder="Search by name or ID..." onkeyup="window.renderTable()">
                    </div>
                    <div class="border-start ps-0 ps-md-3 w-100 w-md-auto">
                        <select id="filterClass" class="form-select border-0 fw-bold text-primary bg-transparent" onchange="window.renderTable()"></select>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-container" id="exportTableContainer">
                    <div class="table-responsive">
                        <table class="table" id="mainFeeTable">
                            <thead>
                                <tr>
                                    <th class="sticky-col ps-4">Student Profile</th>
                                    <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th><th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
                                    <th class="text-end">Paid</th><th class="text-end">Due</th><th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS PAGE -->
            <div id="page-analytics" class="page-section">
                <h2 class="fw-bold mb-4">Financial Insights</h2>
                
                <div class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6 class="text-uppercase text-muted fw-bold small mb-2">Total Students</h6>
                            <h2 class="fw-bold text-dark mb-0 display-5" id="stat-count">0</h2>
                            <i class="fas fa-users stat-icon-bg"></i>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6 class="text-uppercase text-muted fw-bold small mb-2">Total Collected</h6>
                            <h2 class="fw-bold text-success mb-0 display-5" id="stat-collected">₹0</h2>
                            <i class="fas fa-wallet stat-icon-bg text-success"></i>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h6 class="text-uppercase text-muted fw-bold small mb-2">Pending Dues</h6>
                            <h2 class="fw-bold text-danger mb-0 display-5" id="stat-pending">₹0</h2>
                            <i class="fas fa-chart-line stat-icon-bg text-danger"></i>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card-modern h-100 p-4">
                            <h5 class="fw-bold mb-4">Payment Distribution</h5>
                            <div style="height: 300px;"><canvas id="pieChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-modern h-100 p-4">
                            <h5 class="fw-bold mb-4">Revenue by Class</h5>
                            <div style="height: 300px;"><canvas id="barChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS PAGE -->
            <div id="page-settings" class="page-section">
                <h2 class="fw-bold mb-4">System Settings</h2>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card-modern h-100 p-4">
                            <h5 class="fw-bold mb-4 text-primary"><i class="fas fa-university me-2"></i>Institute Details</h5>
                            <form>
                                <div class="mb-3">
                                    <label class="small text-muted fw-bold mb-1">Institute Name</label>
                                    <input type="text" id="setInstName" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted fw-bold mb-1">Tagline</label>
                                    <input type="text" id="setTagline" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted fw-bold mb-1">Address</label>
                                    <textarea id="setAddress" class="form-control" rows="3"></textarea>
                                </div>
                                <button type="button" onclick="window.saveInstitute()" class="btn btn-brand w-100 mt-2">Save Profile</button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-modern mb-4 p-4">
                            <h5 class="fw-bold mb-3 text-success"><i class="fas fa-layer-group me-2"></i>Classes</h5>
                            <div class="input-group mb-3">
                                <input type="text" id="newClassInput" class="form-control" placeholder="Add new class">
                                <button class="btn btn-success" onclick="window.addNewClass()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="classListContainer" class="d-flex flex-wrap gap-2"></div>
                        </div>

                        <div class="card-modern p-4">
                            <h5 class="fw-bold mb-3 text-danger"><i class="fas fa-lock me-2"></i>Security</h5>
                            <form>
                                <div class="row g-2 mb-3">
                                    <div class="col-6"><input type="text" id="setAdminUser" class="form-control" placeholder="New User"></div>
                                    <div class="col-6"><input type="text" id="setAdminPass" class="form-control" placeholder="New Pass"></div>
                                </div>
                                <button type="button" onclick="window.updateAdmin()" class="btn btn-outline-danger w-100 rounded-pill">Update Login</button>
                            </form>
                            <div class="mt-3 pt-3 border-top">
                                <button onclick="window.shareAdminLink()" class="btn btn-light w-100 text-muted small"><i class="fas fa-link me-2"></i> Copy Portal Link</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="page-profile" class="page-section">
                <h2 class="fw-bold mb-4">Admin Profile</h2>
                <div class="card-modern p-4 text-center">
                    <div class="mb-3">
                        <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle shadow-sm" style="width: 90px; height: 90px; font-size: 2.5rem;">
                            <i class="fas fa-user-shield"></i>
                        </div>
                    </div>
                    <h4 class="fw-bold inst-name-display text-dark mb-1">RD CLASSES</h4>
                    <p class="text-muted mb-4 small"><i class="fas fa-user me-2"></i><span id="profile-user-display">admin</span></p>

                    <div class="d-grid gap-3" style="max-width: 400px; margin: 0 auto;">
                        <button onclick="window.shareAdminLink()" class="btn btn-outline-primary rounded-pill py-2">
                            <i class="fas fa-share-alt me-2"></i> Share Dashboard Link
                        </button>
                        <button onclick="window.logout()" class="btn btn-danger rounded-pill py-2">
                            <i class="fas fa-sign-out-alt me-2"></i> Log Out
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 3. STUDENT VIEW (Mobile Optimized) -->
    <div id="student-view">
        
        <!-- GENERAL NOTIFICATION ALERT (Blue) -->
        <div id="student-alert-box">
            <i class="fas fa-bell fa-lg me-2"></i>
            <span id="student-alert-text" class="fw-bold"></span>
        </div>

        <!-- FEE REMINDER ALERT (Red) -->
        <div id="fee-alert-box">
            <i class="fas fa-hand-holding-usd fa-lg me-2"></i>
            <span id="fee-alert-text"></span>
        </div>

        <div class="student-hero">
            <div class="container">
                <div class="bg-white text-primary d-inline-flex align-items-center justify-content-center rounded-circle mb-3 shadow-lg" style="width: 70px; height: 70px;">
                     <img src="https://i.ibb.co/67SHZzkN/G5.png" style="width: 50px; height: 50px; object-fit: contain;">
                </div>
                <h1 class="fw-bold mb-0 inst-name-display text-white">RD CLASSES</h1>
                <p class="opacity-75 small text-uppercase letter-spacing-2 text-white">Student Portal</p>
            </div>
        </div>
        
        <div class="container pb-5" style="max-width: 900px;">
            <!-- ID Card -->
            <div class="id-card p-4 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="me-4 position-relative">
                                <img id="stu-image" src="" class="rounded-circle shadow border border-3 border-white" style="width: 100px; height: 100px; object-fit: cover;">
                                <div class="position-absolute bottom-0 end-0 bg-success border border-2 border-white rounded-circle p-2"></div>
                            </div>
                            <div>
                                <h2 class="fw-bold mb-0 text-dark" id="stu-name">--</h2>
                                <p class="text-muted mb-1"><i class="fas fa-id-card me-2 text-primary"></i><span id="stu-adm" class="fw-bold">--</span></p>
                                <p class="text-muted mb-0 small"><i class="fas fa-phone-alt me-2"></i><span id="stu-mobile-display">--</span></p>
                                <div id="stu-multi-classes" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <div class="bg-light p-3 rounded-4 d-inline-block text-center border" style="min-width: 140px;">
                            <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem; letter-spacing: 1px;">Class</small>
                            <span class="fs-3 fw-bold text-dark" id="stu-class">--</span>
                        </div>
                    </div>
                </div>
                <hr class="my-4 opacity-10">
                <div class="row text-center g-0">
                    <div class="col-4 border-end">
                        <small class="text-muted fw-bold text-uppercase" style="font-size:0.65rem;">Monthly Fee</small>
                        <h4 class="fw-bold text-dark mb-0" id="stu-monthly">₹0</h4>
                    </div>
                    <div class="col-4 border-end">
                        <small class="text-muted fw-bold text-uppercase" style="font-size:0.65rem;">Paid</small>
                        <h4 class="fw-bold text-success mb-0" id="stu-total-paid">₹0</h4>
                    </div>
                    <div class="col-4">
                        <small class="text-muted fw-bold text-uppercase" style="font-size:0.65rem;">Due</small>
                        <h4 class="fw-bold text-danger mb-0" id="stu-total-pending">₹0</h4>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card-modern p-4 mb-4 border-0">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                    <div class="text-center text-md-start">
                        <h5 class="fw-bold text-dark mb-1">Annual Statement</h5>
                        <p class="small text-muted mb-0">Download report for the academic year</p>
                    </div>
                    <div class="btn-group shadow-sm rounded-pill">
                        <button onclick="window.viewYearReport()" class="btn btn-outline-dark border-0 px-4">Preview</button>
                        <button onclick="window.downloadYearPDF()" class="btn btn-dark px-4"><i class="fas fa-download me-2"></i>Save Report</button>
                        <button onclick="window.shareYearPDF()" class="btn btn-outline-dark border-0"><i class="fas fa-share-alt"></i></button>
                    </div>
                </div>
            </div>

            <!-- Month Grid -->
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h5 class="fw-bold text-muted mb-0 small text-uppercase">Payment History</h5>
            </div>
            <div class="row g-3" id="student-month-grid">
                <!-- JS Populated -->
            </div>
        </div>
    </div>

    <!-- 4. CAPTURE AREAS (HIDDEN) -->
    <div id="receipt-capture-area">
        <div style="border: 2px solid #1E3A8A; padding: 40px; background: #fff; position: relative; font-family: 'Plus Jakarta Sans', sans-serif;">
            <div class="watermark inst-name-display" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 5rem; color: rgba(0,0,0,0.03); font-weight: bold; white-space: nowrap;">RD CLASSES</div>
            <div class="d-flex justify-content-between align-items-start mb-4 border-bottom pb-3">
                <div><h1 class="fw-bold mb-1 inst-name-display" style="color: #1E3A8A;">RD CLASSES</h1><p class="mb-0 text-muted" id="rec-tagline">Education</p><small id="rec-address">Address</small></div>
                <div class="text-end">
                    <span class="badge bg-success fs-5 px-3 py-2">PAID</span>
                    <p class="mb-0 fw-bold mt-2">Date: <span id="rec-date"></span></p>
                    <small>Receipt #: <span id="rec-id"></span></small>
                </div>
            </div>
            <div class="text-center mb-3 text-uppercase text-muted fw-bold" style="font-size: 0.9rem;">
                Fee Receipt for <span id="rec-month" class="text-dark"></span>
            </div>
            <div class="row mb-4">
                <div class="col-8"><p class="mb-1 text-uppercase text-muted small fw-bold">Student Details</p><h3 id="rec-name" class="fw-bold text-dark mb-1"></h3><p class="mb-0">Class: <span id="rec-class" class="fw-bold"></span> | Adm No: <span id="rec-adm" class="fw-bold"></span></p><p class="mb-0">Mobile: <span id="rec-mobile"></span></p></div>
                <div class="col-4 text-end"><img id="rec-photo-img" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #eee; object-fit: cover;"></div>
            </div>
            <table class="table table-bordered mb-4" style="border-color: #000;">
                <thead style="background: #f0f0f0;"><tr><th class="py-3">Description</th><th class="text-end py-3">Amount (INR)</th></tr></thead>
                <tbody id="rec-items-body"></tbody>
                <tfoot><tr class="table-light"><td class="text-end py-3"><strong>TOTAL RECEIVED</strong></td><td class="text-end fw-bold py-3 fs-5" id="rec-total"></td></tr></tfoot>
            </table>
            <div class="row mt-5 pt-3"><div class="col-6"><p class="text-muted small">Generated via Portal</p></div><div class="col-6 text-end"><div style="height: 40px;"></div><p class="border-top border-dark d-inline-block pt-2 px-5 fw-bold">Authorized Signature</p></div></div>
        </div>
    </div>

    <div id="year-report-capture-area">
        <div style="border: 2px solid #333; padding: 40px; background: white; font-family: 'Plus Jakarta Sans', sans-serif;">
            <div class="text-center mb-4 border-bottom pb-3">
                <h1 class="fw-bold mb-1 inst-name-display" style="color: #1E3A8A;">RD CLASSES</h1>
                <p class="mb-0 text-muted" id="yr-tagline">Excellence</p>
                <small id="yr-address">Address</small>
                <h3 class="mt-3 fw-bold text-uppercase">Annual Statement</h3>
            </div>
            <div class="row mb-4">
                <div class="col-6"><small class="text-muted fw-bold">STUDENT</small><h4 class="fw-bold" id="yr-name"></h4><p class="mb-0">Class: <span id="yr-class"></span></p><p>Adm: <span id="yr-adm"></span></p></div>
                <div class="col-6 text-end"><small class="text-muted fw-bold">DATE</small><h5 id="yr-date"></h5><div class="mt-2"><span id="yr-status-badge" class="badge bg-secondary">Pending</span></div></div>
            </div>
            <table class="table table-striped table-bordered"><thead class="table-dark"><tr><th>Month</th><th>Fee</th><th>Status</th></tr></thead><tbody id="yr-tbody"></tbody><tfoot><tr class="table-light"><td colspan="2" class="text-end fw-bold">TOTAL PAID:</td><td class="fw-bold text-success" id="yr-paid-total"></td></tr><tr class="table-light"><td colspan="2" class="text-end fw-bold">TOTAL DUE:</td><td class="fw-bold text-danger" id="yr-due-total"></td></tr></tfoot></table>
        </div>
    </div>

    <!-- TOAST -->
    <div id="custom-toast"><i class="fas fa-check-circle me-2"></i><span id="toast-msg">Success</span></div>
    
    <!-- MODALS -->
    <!-- Add/Edit Student Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Student Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="studentForm">
                        <input type="hidden" id="editId">
                        <div class="row">
                            <div class="col-md-3 text-center mb-3">
                                <div class="position-relative d-inline-block">
                                    <div style="width: 100px; height: 100px; background: #f8f9fa; border-radius: 50%; margin: 0 auto 10px; overflow: hidden; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                        <img id="previewImg" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <label class="btn btn-sm btn-primary rounded-circle shadow-sm position-absolute bottom-0 end-0" style="width:32px; height:32px; padding:4px;"><i class="fas fa-camera"></i><input type="file" id="inpFile" accept="image/*" hidden onchange="window.handleImageUpload(this)"></label>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="mb-3">
                                    <label class="small fw-bold text-muted mb-1">Full Name</label>
                                    <input type="text" class="form-control" id="inpName" required placeholder="e.g. John Doe">
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <label class="small fw-bold text-muted mb-1">Class</label>
                                        <select class="form-select" id="inpClass"></select>
                                    </div>
                                    <div class="col-6">
                                        <label class="small fw-bold text-muted mb-1">Adm No</label>
                                        <input type="text" class="form-control bg-light" id="inpAdm" readonly>
                                    </div>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <label class="small fw-bold text-muted mb-1">Monthly Fee (₹)</label>
                                        <input type="number" class="form-control" id="inpFee" required>
                                    </div>
                                    <div class="col-6">
                                        <label class="small fw-bold text-muted mb-1">Mobile No</label>
                                        <input type="text" class="form-control" id="inpMobile" placeholder="+91...">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-light p-3 rounded-4 mt-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="small fw-bold text-primary">Extra Subjects / Fees</label>
                                <button type="button" class="btn btn-sm btn-white border rounded-pill shadow-sm hover-lift" onclick="window.addExtraRow()">+ Add Item</button>
                            </div>
                            <div id="extraClassesContainer"></div>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="button" class="btn btn-brand py-2" onclick="window.saveStudent()">Save Student Record</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-body text-center p-5">
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle d-inline-block mb-3">
                        <i class="fas fa-trash-alt fa-2x text-danger"></i>
                    </div>
                    <h4 class="fw-bold">Delete Record?</h4>
                    <p class="text-muted">This action cannot be undone. All fee history will be lost.</p>
                    <div class="d-flex justify-content-center gap-2 mt-4">
                        <button class="btn btn-light px-4 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-danger px-4 rounded-pill shadow-sm" onclick="window.confirmDelete()">Yes, Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ms-2">Document Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center bg-light m-3 rounded-4" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div id="doc-preview-container" class="shadow-lg"></div>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-brand px-5" id="finalDownloadBtn">
                        <i class="fas fa-download me-2"></i> Download Image
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC WITH FIREBASE -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Your Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD1B-_P5gE7JTU9uRqJMAnMyPVhDxa1LcE",
            authDomain: "rd-classes-68273.firebaseapp.com",
            databaseURL: "https://rd-classes-68273-default-rtdb.firebaseio.com",
            projectId: "rd-classes-68273",
            storageBucket: "rd-classes-68273.firebasestorage.app",
            messagingSenderId: "1024297886734",
            appId: "1:1024297886734:web:3a22a7c5539f33250e085f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global Variables
        let students = [];
        let settings = { instName: "RD CLASSES", tagline: "Excellence in Education", address: "123 Education Lane", adminUser: "admin", adminPass: "admin" };
        let classList = ['Class 1', 'Class 2', 'Class 3', 'Class 4', 'Class 5', 'Class 6', 'Class 7', 'Class 8', 'Class 9', 'Class 10'];
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        let tempImageBase64 = "";
        let deleteId = null;
        let currentStudentId = null;
        let chartInstancePie = null;
        let chartInstanceBar = null;
        let alertInterval = null;
        let feeAlertInterval = null;
        const { jsPDF } = window.jspdf;

        // --- INIT & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Listen for Students
            onValue(ref(db, 'students'), (snapshot) => {
                const data = snapshot.val();
                students = data ? Object.values(data) : [];
                window.renderTable();
                window.renderCharts();
                
                // If on student view, refresh data
                const params = new URLSearchParams(window.location.search);
                if(params.get('id')) { 
                    window.loadStudentDashboard(params.get('id'));
                }
            });

            // Listen for Settings
            onValue(ref(db, 'settings'), (snapshot) => {
                if(snapshot.exists()) {
                    settings = snapshot.val();
                    window.loadSettings();
                } else {
                    // Initial Save if empty
                    set(ref(db, 'settings'), settings);
                }
            });

            // Listen for Class List
            onValue(ref(db, 'classes'), (snapshot) => {
                if(snapshot.exists()) {
                    classList = snapshot.val();
                } else {
                    // Initial Save if empty
                    set(ref(db, 'classes'), classList);
                }
                window.renderClassUI();
            });

            const params = new URLSearchParams(window.location.search);
            if(params.get('id')) { 
                document.getElementById('auth-view').remove(); 
                currentStudentId = params.get('id');
                // loadStudentDashboard called by onValue
            } else { 
                document.getElementById('auth-view').style.display = 'flex'; 
            }
        });

        // --- GLOBAL FUNCTIONS (EXPOSED TO WINDOW) ---

        window.showToast = function(msg, type="success") { 
            const t = document.getElementById('custom-toast'); 
            document.getElementById('toast-msg').innerText = msg; 
            const icon = t.querySelector('i');
            if(type === "error") {
                icon.className = "fas fa-exclamation-circle me-2 text-danger";
            } else {
                icon.className = "fas fa-check-circle me-2 text-success";
            }
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        }

        window.handleLogin = function() { 
            if(document.getElementById('loginUser').value===settings.adminUser && document.getElementById('loginPass').value===settings.adminPass) { 
                document.getElementById('auth-view').style.display='none'; 
                document.getElementById('dashboard-view').style.display='block'; 
                window.renderTable(); 
                window.renderCharts(); 
            } else {
                window.showToast("Invalid Credentials", "error"); 
            }
        }

        window.logout = function() { location.reload(); }

        window.switchPage = function(page) { 
            document.querySelectorAll('.page-section, .nav-link').forEach(el=>el.classList.remove('active')); 
            document.getElementById('page-'+page).classList.add('active'); 
            document.getElementById('nav-'+page).classList.add('active'); 
            if(page==='analytics') setTimeout(window.renderCharts, 100); 
        }

        window.addExtraRow = function(name='', fee='') { 
            const div=document.createElement('div'); 
            div.className="row g-2 mb-2 extra-class-row"; 
            div.innerHTML=`<div class="col-6"><input type="text" class="form-control form-control-sm ex-name" placeholder="Subject" value="${name}"></div><div class="col-5"><input type="number" class="form-control form-control-sm ex-fee" placeholder="Fee" value="${fee}"></div><div class="col-1"><button type="button" class="btn btn-sm btn-light text-danger" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-times"></i></button></div>`; 
            document.getElementById('extraClassesContainer').appendChild(div); 
        }

        window.getStudentTotalFee = function(s) { 
            let t=parseFloat(s.monthlyFee)||0; 
            if(s.extras) s.extras.forEach(e=>t+=parseFloat(e.fee)); 
            return t; 
        }
        
        window.saveStudent = function() { 
            const id=document.getElementById('editId').value;
            const name=document.getElementById('inpName').value;
            const cls=document.getElementById('inpClass').value;
            const adm=document.getElementById('inpAdm').value;
            const fee=Number(document.getElementById('inpFee').value);
            const mob=document.getElementById('inpMobile').value;
            const extras=[]; 
            document.querySelectorAll('.extra-class-row').forEach(r=>{ 
                const n=r.querySelector('.ex-name').value;
                const f=parseFloat(r.querySelector('.ex-fee').value)||0; 
                if(n) extras.push({name:n, fee:f}); 
            });

            if(!name) return window.showToast("Name Required", "error");
            
            const newId = id ? id : Date.now().toString(); // ID must be string for Firebase key
            const oldData = students.find(s => s.id == newId) || {};

            const obj = { 
                id: newId, 
                name, 
                class: cls, 
                adm, 
                monthlyFee: fee, 
                mobile: mob, 
                extras: extras, 
                photo: tempImageBase64 || oldData.photo || "",
                fees: oldData.fees || Array(12).fill(false),
                alertMsg: oldData.alertMsg || "",
                feeAlert: oldData.feeAlert || ""
            };

            set(ref(db, 'students/' + newId), obj)
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide(); 
                    window.showToast("Saved!");
                })
                .catch((e) => window.showToast("Error: " + e.message, "error"));
        }

        window.openAddModal = function() { 
            document.getElementById('studentForm').reset(); 
            document.getElementById('editId').value=''; 
            document.getElementById('inpAdm').value=`RDC-${Math.floor(100000+Math.random()*900000)}`; 
            document.getElementById('previewImg').src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"; 
            tempImageBase64=""; 
            document.getElementById('extraClassesContainer').innerHTML=''; 
            new bootstrap.Modal(document.getElementById('studentModal')).show(); 
        }

        window.editStu = function(id) { 
            const s=students.find(x=>x.id==id); 
            document.getElementById('editId').value=s.id; 
            document.getElementById('inpName').value=s.name; 
            document.getElementById('inpClass').value=s.class; 
            document.getElementById('inpAdm').value=s.adm; 
            document.getElementById('inpFee').value=s.monthlyFee; 
            document.getElementById('inpMobile').value=s.mobile; 
            document.getElementById('previewImg').src=s.photo||"https://cdn-icons-png.flaticon.com/512/3135/3135715.png"; 
            tempImageBase64=""; 
            const c=document.getElementById('extraClassesContainer'); 
            c.innerHTML=''; 
            if(s.extras) s.extras.forEach(e=>window.addExtraRow(e.name,e.fee)); 
            else if(s.extraName) window.addExtraRow(s.extraName,s.extraFee); 
            new bootstrap.Modal(document.getElementById('studentModal')).show(); 
        }
        
        window.renderCharts = function() { 
            let p=0, d=0, c={}; 
            students.forEach(s=>{ 
                let t=window.getStudentTotalFee(s);
                let pa=0;
                if(s.fees) pa = s.fees.filter(Boolean).length*t; 
                p+=pa; 
                d+=((t*12)-pa); 
                let k=s.class||"Other"; 
                if(!c[k])c[k]=0; 
                c[k]+=pa; 
            });
            document.getElementById('stat-count').innerText=students.length; 
            document.getElementById('stat-collected').innerText='₹'+p.toLocaleString(); 
            document.getElementById('stat-pending').innerText='₹'+d.toLocaleString();
            
            if(chartInstancePie)chartInstancePie.destroy(); 
            if(chartInstanceBar)chartInstanceBar.destroy();
            
            chartInstancePie=new Chart(document.getElementById('pieChart'),{
                type:'doughnut',
                data:{
                    labels:['Paid','Due'],
                    datasets:[{data:[p,d],backgroundColor:['#10B981','#EF4444']}]
                },
                options:{responsive:true,maintainAspectRatio:false}
            });
            
            chartInstanceBar=new Chart(document.getElementById('barChart'),{
                type:'bar',
                data:{
                    labels:Object.keys(c),
                    datasets:[{label:'Collected',data:Object.values(c),backgroundColor:'#4F46E5',borderRadius:5}]
                },
                options:{responsive:true,maintainAspectRatio:false}
            });
        }

        window.renderTable = function() {
            const tbody=document.getElementById('admin-table-body'), term=document.getElementById('searchBox').value.toLowerCase(), filter=document.getElementById('filterClass').value; 
            tbody.innerHTML='';
            students.filter(s=>(s.name.toLowerCase().includes(term)||s.adm.toLowerCase().includes(term))&&(filter===''||s.class===filter)).forEach(s=>{
                const t=window.getStudentTotalFee(s);
                const fees = s.fees || Array(12).fill(false);
                const p = fees.filter(Boolean).length*t;
                
                let chk=''; 
                fees.forEach((f,i)=>chk+=`<td class="text-center p-0"><input type="checkbox" ${f?'checked':''} onchange="window.toggleFee('${s.id}',${i}, ${!f})"></td>`);
                
                const alertActive = s.alertMsg ? 'text-warning' : 'text-muted';
                const feeActive = s.feeAlert ? 'text-danger' : 'text-muted';

                tbody.insertAdjacentHTML('beforeend',`<tr>
                    <td class="sticky-col ps-4">
                        <div class="d-flex align-items-center"><img src="${s.photo||'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="avatar-circle me-3"><div class="fw-bold text-dark">${s.name}<div class="small text-muted fw-normal">${s.class} | ${s.adm}</div></div></div>
                        <div class="mt-2 text-center">
                            <i class="fas fa-pen text-primary me-3" style="cursor:pointer" onclick="window.editStu('${s.id}')"></i>
                            <i class="fab fa-whatsapp text-success me-3" style="cursor:pointer" onclick="window.shareStudentDetails('${s.id}')"></i>
                            <i class="fas fa-bell ${alertActive} me-3" style="cursor:pointer" onclick="window.setNotification('${s.id}')"></i>
                            <i class="fas fa-hand-holding-usd ${feeActive} me-3" style="cursor:pointer" onclick="window.toggleFeeAlert('${s.id}')"></i>
                            <i class="fas fa-trash text-danger" style="cursor:pointer" onclick="window.requestDelete('${s.id}')"></i>
                        </div>
                    </td>
                    ${chk}
                    <td class="text-end fw-bold text-success">₹${p}</td>
                    <td class="text-end fw-bold text-danger">₹${(t*12)-p}</td>
                    <td class="text-center"><a href="?id=${s.id}" target="_blank" class="btn btn-sm btn-light border rounded-pill">View</a></td>
                </tr>`);
            });
        }

        window.setNotification = function(id) {
            const s = students.find(x => x.id == id);
            const defaultMsg = "Dear Student, please contact the office.";
            const currentMsg = s.alertMsg || defaultMsg;
            const newMsg = prompt("Enter Notification Message (Clear to remove):", currentMsg);
            
            if (newMsg !== null) { 
                update(ref(db, 'students/' + id), { alertMsg: newMsg.trim() });
                if(newMsg.trim()) window.showToast("Notification Active");
                else window.showToast("Notification Removed", "error");
            }
        }

        window.toggleFeeAlert = function(id) {
            const s = students.find(x => x.id == id);
            const t = window.getStudentTotalFee(s);
            const fees = s.fees || Array(12).fill(false);
            const paid = fees.filter(Boolean).length * t;
            const due = (t * 12) - paid;
            const defaultFeeMsg = `Dear Student, you have pending dues of ₹${due}. Please pay immediately.`;
            
            let msg = s.feeAlert || defaultFeeMsg;
            const newFeeMsg = prompt("Set Fee Reminder Message (Clear to remove):", msg);

            if(newFeeMsg !== null) {
                update(ref(db, 'students/' + id), { feeAlert: newFeeMsg.trim() });
                if(newFeeMsg.trim()) window.showToast("Fee Reminder Active");
                else window.showToast("Fee Reminder Removed", "error");
            }
        }

        window.showStudentAlert = function(msg) {
            const box = document.getElementById('student-alert-box');
            const txt = document.getElementById('student-alert-text');
            if(box && txt) {
                txt.innerText = msg;
                box.classList.add('active'); 
                setTimeout(() => { box.classList.remove('active'); }, 5000); 
            }
        }

        window.showFeeAlert = function(msg) {
            const box = document.getElementById('fee-alert-box');
            const txt = document.getElementById('fee-alert-text');
            if(box && txt) {
                txt.innerText = msg;
                box.classList.add('active'); 
                setTimeout(() => { box.classList.remove('active'); }, 5000); 
            }
        }

        window.viewReceipt = function(id, idx) { 
            const s = students.find(x => x.id == id); 
            const date = new Date(); 
            const totalMonthly = window.getStudentTotalFee(s);
            document.getElementById('rec-tagline').innerText = settings.tagline; 
            document.getElementById('rec-address').innerText = settings.address; 
            document.getElementById('rec-date').innerText = date.toLocaleDateString(); 
            document.getElementById('rec-id').innerText = `RCV-${id}-${idx+1}`; 
            document.getElementById('rec-name').innerText = s.name; 
            document.getElementById('rec-class').innerText = s.class; 
            document.getElementById('rec-adm').innerText = s.adm; 
            document.getElementById('rec-mobile').innerText = s.mobile || 'N/A'; 
            document.getElementById('rec-month').innerText = MONTHS[idx]; 
            document.getElementById('rec-total').innerText = '₹' + totalMonthly; 
            document.getElementById('rec-photo-img').src = s.photo || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            
            let rows = `<tr><td class="py-3">Tuition Fee (${s.class})</td><td class="text-end fw-bold py-3">₹${s.monthlyFee}</td></tr>`;
            if (s.extras) s.extras.forEach(e => { rows += `<tr><td class="py-3">Extra: ${e.name}</td><td class="text-end fw-bold py-3">₹${e.fee}</td></tr>`; });
            else if (s.extraName) rows += `<tr><td class="py-3">Extra: ${s.extraName}</td><td class="text-end fw-bold py-3">₹${s.extraFee}</td></tr>`;
            document.getElementById('rec-items-body').innerHTML = rows;
            
            const container = document.getElementById('doc-preview-container'); 
            container.innerHTML = '<div class="spinner-border text-primary m-5"></div>';
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
            setTimeout(() => {
                const element = document.getElementById('receipt-capture-area');
                html2canvas(element, { scale: 2 }).then(canvas => {
                    container.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL("image/png");
                    img.style.maxWidth = "100%";
                    img.className = "rounded shadow-sm border";
                    container.appendChild(img);
                    document.getElementById('finalDownloadBtn').onclick = () => {
                        const link = document.createElement('a');
                        link.download = `Receipt_${s.name}_${MONTHS[idx]}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    };
                });
            }, 500); 
        }

        window.renderClassUI = function() { 
            const c=document.getElementById('classListContainer'), o=document.getElementById('filterClass'), i=document.getElementById('inpClass'); 
            c.innerHTML=classList.map(x=>`<span class="badge bg-white text-dark border p-2 me-1 mb-1 shadow-sm">${x} <i class="fas fa-times text-danger ms-2" onclick="window.deleteClass('${x}')" style="cursor:pointer"></i></span>`).join(''); 
            o.innerHTML=`<option value="">All</option>`+classList.map(x=>`<option>${x}</option>`).join(''); 
            i.innerHTML=classList.map(x=>`<option>${x}</option>`).join(''); 
        }
        
        window.addNewClass = function() { 
            const v=document.getElementById('newClassInput').value.trim(); 
            if(v&&!classList.includes(v)){
                const newList = [...classList, v];
                set(ref(db, 'classes'), newList);
                document.getElementById('newClassInput').value=''; 
                window.showToast("Class Added");
            } 
        }
        
        window.deleteClass = function(c) { 
            if(confirm("Remove?")){
                const newList = classList.filter(x=>x!==c); 
                set(ref(db, 'classes'), newList);
            } 
        }
        
        window.loadSettings = function() { 
            document.querySelectorAll('.inst-name-display').forEach(el=>el.innerText=settings.instName); 
            document.getElementById('setInstName').value=settings.instName; 
            document.getElementById('setTagline').value=settings.tagline; 
            document.getElementById('setAddress').value=settings.address; 
            document.getElementById('setAdminUser').value=settings.adminUser; 
            document.getElementById('setAdminPass').value=settings.adminPass; 
            document.getElementById('profile-user-display').innerText = settings.adminUser;
        }
        
        window.saveInstitute = function() { 
            settings.instName=document.getElementById('setInstName').value; 
            settings.tagline=document.getElementById('setTagline').value; 
            settings.address=document.getElementById('setAddress').value; 
            set(ref(db, 'settings'), settings);
            window.showToast("Saved!"); 
        }
        
        window.updateAdmin = function() { 
            const u=document.getElementById('setAdminUser').value; 
            const p=document.getElementById('setAdminPass').value; 
            if(u&&p){
                settings.adminUser=u; settings.adminPass=p; 
                set(ref(db, 'settings'), settings);
                alert("Login Updated"); 
                location.reload();
            } 
        }
        
        window.shareAdminLink = function() { navigator.clipboard.writeText(window.location.href.split('?')[0]).then(()=>window.showToast("Link Copied!")); }
        
        window.handleImageUpload = function(i) { if(i.files[0]){const r=new FileReader(); r.onload=(e)=>{tempImageBase64=e.target.result; document.getElementById('previewImg').src=tempImageBase64;}; r.readAsDataURL(i.files[0]);} }
        
        window.requestDelete = function(id){ 
            deleteId = id; 
            new bootstrap.Modal(document.getElementById('deleteModal')).show(); 
        }
        
        window.confirmDelete = function(){ 
            if(deleteId){ 
                remove(ref(db, 'students/' + deleteId))
                    .then(() => {
                        const modalEl = document.getElementById('deleteModal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if(modal) modal.hide();
                        window.showToast("Deleted", "error"); 
                        deleteId = null;
                    })
                    .catch(e => console.error(e));
            } 
        }

        window.toggleFee = function(id, i, status){ 
            update(ref(db, 'students/' + id + '/fees'), { [i]: status });
        }
        
        window.shareStudentDetails = function(id) { 
            const s=students.find(x=>x.id==id); 
            const t=window.getStudentTotalFee(s);
            const fees = s.fees || Array(12).fill(false);
            const d=(t*12)-(fees.filter(Boolean).length*t); 
            const l=`${window.location.origin}${window.location.pathname}?id=${id}`; 
            window.open(`https://wa.me/?text=*${settings.instName}*%0AStudent: ${s.name}%0ADue: ₹${d}%0ALink: ${l}`, '_blank'); 
        }
        
        window.shareMonthDetail = function(n,m,f) { window.open(`https://wa.me/?text=*Fee Receipt*%0A${n} - ${m}%0APaid: ₹${f}`, '_blank'); }
        
        window.populateYearReport = function(sId) { 
            const s=students.find(x=>x.id==sId); 
            const d=new Date(); 
            const t=window.getStudentTotalFee(s); 
            document.getElementById('yr-name').innerText=s.name; 
            document.getElementById('yr-class').innerText=s.class; 
            document.getElementById('yr-adm').innerText=s.adm; 
            document.getElementById('yr-date').innerText=d.toLocaleDateString(); 
            const tb=document.getElementById('yr-tbody'); 
            tb.innerHTML=''; 
            let tp=0; 
            const fees = s.fees || Array(12).fill(false);
            fees.forEach((p,i)=>{ if(p)tp+=t; tb.insertAdjacentHTML('beforeend',`<tr><td>${MONTHS[i]}</td><td>₹${t}</td><td>${p?'PAID':'PENDING'}</td></tr>`); }); 
            document.getElementById('yr-paid-total').innerText='₹'+tp; 
            document.getElementById('yr-due-total').innerText='₹'+((t*12)-tp); 
        }
        
        window.viewYearReport = function() { 
            if(!currentStudentId)return; 
            window.populateYearReport(currentStudentId); 
            const c=document.getElementById('doc-preview-container'); 
            c.innerHTML='<div class="spinner-border m-5"></div>'; 
            new bootstrap.Modal(document.getElementById('previewModal')).show(); 
            setTimeout(()=>{ html2canvas(document.getElementById('year-report-capture-area'),{scale:1.5}).then(canvas=>{ c.innerHTML=''; const img=document.createElement('img'); img.src=canvas.toDataURL("image/png"); img.style.maxWidth="100%"; img.className="rounded shadow-sm border"; c.appendChild(img); document.getElementById('finalDownloadBtn').onclick=()=>{ const l=document.createElement('a'); l.download=`Report.png`; l.href=canvas.toDataURL("image/png"); l.click(); }; }); },500); 
        }
        
        window.downloadYearPDF = async function() { 
            if(!currentStudentId)return; 
            window.populateYearReport(currentStudentId); 
            window.showToast("Generating Report..."); 
            setTimeout(async () => {
                const c=await html2canvas(document.getElementById('year-report-capture-area'),{scale:2}); 
                const pdf=new jsPDF('p','mm','a4'); 
                pdf.addImage(c.toDataURL('image/png'),'PNG',0,0,pdf.internal.pageSize.getWidth(),(c.height*pdf.internal.pageSize.getWidth())/c.width); 
                pdf.save(`Student_Report_${currentStudentId}.pdf`); 
                window.showToast("Report Saved!");
            }, 100);
        }
        
        window.shareYearPDF = async function() { 
            if(!currentStudentId)return; 
            if(!navigator.share)return window.showToast("Use Download","error"); 
            window.populateYearReport(currentStudentId); 
            const c=await html2canvas(document.getElementById('year-report-capture-area'),{scale:2}); 
            c.toBlob(async(b)=>{ try{await navigator.share({files:[new File([b],"Report.png",{type:"image/png"})]});}catch(e){} }); 
        }
        
        window.exportToExcel = function() { 
            const d=students.map(s=>{
                let r={"Name":s.name,"Class":s.class}; 
                const fees = s.fees || Array(12).fill(false);
                fees.forEach((f,i)=>r[MONTHS[i]]=f?"PAID":"DUE"); 
                return r;
            }); 
            const w=XLSX.utils.json_to_sheet(d), b=XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(b,w,"Fees"); 
            XLSX.writeFile(b,"Data.xlsx"); 
        }
        
        window.exportToWord = function() { const h="<html><body>"+document.getElementById("mainFeeTable").outerHTML+"</body></html>", b=new Blob(['\ufeff',h],{type:'application/msword'}), u=URL.createObjectURL(b), l=document.createElement('a'); l.href=u; l.download='Report.doc'; l.click(); }
        
        window.exportToImage = function() { window.showToast("Capturing..."); html2canvas(document.getElementById("exportTableContainer")).then(c=>{const l=document.createElement('a'); l.download='Table.png'; l.href=c.toDataURL(); l.click();}); }

        window.loadStudentDashboard = function(id) {
            const s=students.find(x=>x.id==id); if(!s)return;
            document.getElementById('student-view').style.display='block'; 
            document.getElementById('stu-name').innerText=s.name; 
            document.getElementById('stu-adm').innerText=s.adm; 
            document.getElementById('stu-class').innerText=s.class; 
            document.getElementById('stu-mobile-display').innerText=s.mobile||'N/A'; 
            document.getElementById('stu-image').src=s.photo||"https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            
            const t=window.getStudentTotalFee(s); 
            document.getElementById('stu-monthly').innerText='₹'+t;
            let h=''; if(s.extras) s.extras.forEach(e=>h+=`<span class="badge bg-warning text-dark me-1 border">${e.name}</span>`);
            document.getElementById('stu-multi-classes').innerHTML=h;
            
            let p=0; 
            const g=document.getElementById('student-month-grid'); 
            g.innerHTML='';
            const fees = s.fees || Array(12).fill(false);
            
            fees.forEach((f,i)=>{
                if(f)p+=t;
                const btn = f ? `<div class="d-flex gap-2 mt-2"><button onclick="window.viewReceipt('${s.id}',${i})" class="btn btn-sm btn-brand rounded-pill w-100 shadow-sm"><i class="fas fa-eye me-1"></i>View</button><button onclick="window.shareMonthDetail('${s.name}','${MONTHS[i]}',${t})" class="btn btn-sm btn-success rounded-circle shadow-sm"><i class="fab fa-whatsapp"></i></button></div>` : `<button class="btn btn-sm btn-light rounded-pill w-100 text-muted border" disabled>Due</button>`;
                g.insertAdjacentHTML('beforeend',`<div class="col-md-3 col-6"><div class="month-grid-item p-3 text-center h-100"><h6 class="fw-bold text-dark mb-1">${MONTHS[i]}</h6><div class="mb-2 ${f?'text-success':'text-danger'} small fw-bold">${f?'PAID':'PENDING'}</div>${btn}</div></div>`);
            });
            document.getElementById('stu-total-paid').innerText='₹'+p; 
            document.getElementById('stu-total-pending').innerText='₹'+((t*12)-p);

            // Handle General Notifications (10s Loop)
            if(alertInterval) clearInterval(alertInterval);
            if(s.alertMsg && s.alertMsg.length > 0) {
                window.showStudentAlert(s.alertMsg);
                alertInterval = setInterval(() => { window.showStudentAlert(s.alertMsg); }, 10000); 
            }

            // Handle Fee Notifications (7s Loop)
            if(feeAlertInterval) clearInterval(feeAlertInterval);
            if(s.feeAlert && s.feeAlert.length > 0) {
                setTimeout(() => window.showFeeAlert(s.feeAlert), 3000); // Start offset
                feeAlertInterval = setInterval(() => { window.showFeeAlert(s.feeAlert); }, 7000); 
            }
        }
    </script>
</body>
</html>